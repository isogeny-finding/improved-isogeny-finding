load('find_roots.sage')
load('cornacchia.sage')

def shortish_iso(method="coron"):
  P.<x1, x2, x3, x4> = PolynomialRing(ZZ)

  forms = [
    {
      "p": 24554940634497023,
      "iso_degree": 199508892655288473,
      "quadratic_form": 2*x1^2 + x1*x4 + 2*x2^2 + x2*x3 + 3069367579312128*x3^2 + 3069367579312128*x4^2,
      "sol": [7, 1, 4, 7],
      "known_variables": [1, 2], # indices of the variables that we know; for example [2, 3] means we know x3 and x4
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 32,
      "quadratic_form": 4*x1^2 + 2*x1*x2 + 4*x1*x3 + x1*x4 + 6*x2^2 + x2*x3 + 6*x2*x4 + 11956566944641502957704189594909498993478297403838643406058180334130656750162*x3^2 + 5978283472320751478852094797454749496739148701919321703029090167065328375081*x3*x4 + 17934850416962254436556284392364248490217446105757965109087270501195985125243*x4^2,
      "sol": [1, 2, 0, 0],
      "known_variables": [0],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**100,
      "quadratic_form": 237684487542793012780631851008*x1^2 + 158456325028528675187087900672*x1*x2 + 11852140596306291853529975864*x1*x3 - 196113268065311140224151971939*x1*x4 + 633825300114114700748351602688*x2^2 + 596168357077332235711287531421*x2*x3 + 101745988080523586886298584190*x2*x4 + 113184818679426280593331075426937368682915116826*x3^2 + 75456545786284187042467149290781092699393451444*x3*x4 + 301826183145136747915503626961815403581827345301*x4^2,
      "sol": [-2, 1, 0, 0],
      "known_variables": [1, 2],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**100,
      "quadratic_form": 237684487542793012780631851008*x1^2 + 158456325028528675187087900672*x1*x2 + 11852140596306291853529975864*x1*x3 - 196113268065311140224151971939*x1*x4 + 633825300114114700748351602688*x2^2 + 596168357077332235711287531421*x2*x3 + 101745988080523586886298584190*x2*x4 + 113184818679426280593331075426937368682915116826*x3^2 + 75456545786284187042467149290781092699393451444*x3*x4 + 301826183145136747915503626961815403581827345301*x4^2,
      "sol": [-2, 1, 0, 0],
      "known_variables": [1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**120,
      "quadratic_form": 41538374868278621028243970633760768*x1^2 + 20825056980564116836958222982316228*x1*x3 + 36941148124127244989345096640962019*x1*x4 + 955382621970408283649611324576497664*x2^2 + 295365850822101723236606668429124125*x2*x3 + 478976310552974687250039128593273244*x2*x4 + 71960995160054093208529545814718687390660*x3^2 + 83300227922256467347832891929264912*x3*x4 + 1655102371831838747847223059215386233660968*x4^2,
      "sol": [-3, 1, 0, 0],
      "known_variables": [2, 3],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**140,
      "quadratic_form": 40473403944771042310329985208052973550*x1^2 + 9748251956265421211829331742284787136*x1*x2 + 9748251956265421211829331742284787136*x1*x3 + 24976524946590553383304748705963317367*x1*x4 + 77454633550189127124614625500468942822*x2^2 + 48985934264245616245264531878868621177*x2*x3 - 9748251956265421211829331742284787136*x2*x4 + 902419591443790462258239566163618070005*x3^2 + 214461543037839266660245298330265316992*x3*x4 + 1716006642762988328172501652596769393989*x4^2,
      "sol": [9, -59, 2, -26],
      "known_variables": [0, 1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**150,
      "quadratic_form": 3897547560480989392878390612806074489*x1^2 + 2549863555395826816290179291063255984*x1*x3 - 2316483448965540237620928129585942081*x1*x4 + 89643593891062756036202984094539713247*x2^2 + 49087054174737412952161615483258835949*x2*x3 + 58646861774104016774674123694454887632*x2*x4 + 774065686297346099914796435657452606484*x3^2 + 15299181332374960897741075746379535904*x3*x4 + 17649300171967851438470970389282875615042*x4^2,
      "sol": [11643, -379, -1076, 12],
      "known_variables": [0, 1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**160,
      "quadratic_form": 120864756928231872170197654963601902031*x1^2 + 40379784023742363682691476922140013988*x1*x2 - 80210377761494289609629402238643748110*x1*x3 - 49019009704082514622267696968581725297*x1*x4 + 194680861828862664977080049082731556942*x2^2 + 156088821196201368396536230067211356461*x2*x3 + 147083019515271147858011236632623029956*x2*x4 + 410215661800567766037607854071586163516*x3^2 + 205107830900283883018803927035793081758*x3*x4 + 615323492700851649056411781107379245274*x4^2,
      "sol": [99533, -30399, 42217, -4004],
      "known_variables": [0, 1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**160,
      "quadratic_form": 120864756928231872170197654963601902031*x1^2 + 40379784023742363682691476922140013988*x1*x2 - 80210377761494289609629402238643748110*x1*x3 - 49019009704082514622267696968581725297*x1*x4 + 194680861828862664977080049082731556942*x2^2 + 156088821196201368396536230067211356461*x2*x3 + 147083019515271147858011236632623029956*x2*x4 + 410215661800567766037607854071586163516*x3^2 + 205107830900283883018803927035793081758*x3*x4 + 615323492700851649056411781107379245274*x4^2,
      "sol": [99533, -30399, 42217, -4004],
      "known_variables": [2],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**165,
      "quadratic_form": 138247101726295456755875073486750847154*x1^2 + 21460434255412846014100199109945618216*x1*x2 - 7153478085137615338033399703315206072*x1*x3 + 29955363653541474694836788320420187257*x1*x4 + 212291917471350331602636068408707319455*x2^2 + 12846160333952246577905930722776062645*x2*x3 + 14306956170275230676066799406630412144*x2*x4 + 325428104581287603783196981068692664128*x3^2 + 50074346595963307366233797923206442504*x3*x4 + 501050875206347183111794445486198453599*x4^2,
      "sol": [262357, -418875, -48673, -49152],
      "known_variables": [0, 1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**165,
      "quadratic_form": 138247101726295456755875073486750847154*x1^2 + 21460434255412846014100199109945618216*x1*x2 - 7153478085137615338033399703315206072*x1*x3 + 29955363653541474694836788320420187257*x1*x4 + 212291917471350331602636068408707319455*x2^2 + 12846160333952246577905930722776062645*x2*x3 + 14306956170275230676066799406630412144*x2*x4 + 325428104581287603783196981068692664128*x3^2 + 50074346595963307366233797923206442504*x3*x4 + 501050875206347183111794445486198453599*x4^2,
      "sol": [262357, -418875, -48673, -49152],
      "known_variables": [0],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**170,
      "quadratic_form": 155092426386982356343410631537502978702*x1^2 + 97600888830184995641397091875629292760*x1*x2 - 141722642629186478030282780799584443096*x1*x3 + 102925910518743119548873625692803306041*x1*x4 + 200388882109716746247505562304808983849*x2^2 + 66658376797360879806403365504646046331*x2*x3 - 133592588073144497498337041536539322566*x2*x4 + 420654471643757990568942777257913418616*x3^2 + 136898674658815950195209675413050796969*x3*x4 + 534370352292577989993348166146157290264*x4^2,
      "sol": [1911741, -1865026, 564043, -1711420],
      "known_variables": [1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**180,
      "quadratic_form": 114727094697098328038541868720587464332*x1^2 + 57363547348549164019270934360293732166*x1*x2 - 28479759541472593460427953409958276582*x1*x3 - 64241305342996695015173358540893910087*x1*x4 + 172090642045647492057812803080881196498*x2^2 + 107849336702650797042639444539987286411*x2*x3 + 53621647152122415697508451614710758954*x2*x4 + 438674171214814889852260952383628095579*x3^2 + 240696905263511890021451441249282755226*x3*x4 + 641658245062352046518091646325782127247*x4^2,
      "sol": [32633575, 16717795, -56942632, 3254465],
      "known_variables": [0, 1],
    }, 
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**200,
      "quadratic_form": 75977507322256808994564300613717071702*x1^2 + 71077098819583582676450096983765637052*x1*x2 + 61276281814237130040221689723862767752*x1*x3 - 24540546577584089835376781243100016933*x1*x4 + 190037733524410719386446026068558561316*x2^2 + 101081845212453080230152729062412381001*x2*x3 - 117464224688263639962258626749242336732*x2*x4 + 416366109651826182081987167299419812007*x3^2 + 338853688248787918094879801256809309090*x3*x4 + 1009791571838362253388691364274969076717*x4^2,
      "sol": [-88672782002, 49105680072, 46212705221, -584134663],
      "known_variables": [0, 1],
    },
    {
      "p": 11956566944641502957704189594909498993478297403838643406058180334130656750161,
      "iso_degree": 2**210,
      "quadratic_form": 122666453208910159294119827758251198761*x1^2 + 111804888627617729773666447208431934036*x1*x2 - 55902444313808864886833223604215967018*x1*x3 - 21990898934841116371930693219530726715*x1*x4 + 130365434097852927774128925626239586077*x2^2 + 14291918045898347891921595351542339399*x2*x3 + 55902444313808864886833223604215967018*x2*x4 + 665594788403821010051695980527613326657*x3^2 + 614926887451897513755165459646375637198*x3*x4 + 707939183293006236691746018801549456895*x4^2,
      "sol": [2959622489098, -3197305538683, -326156486709, -251632385605],
      "known_variables": [0, 1],
    },
    {
      "p" : 1440277892930363003468057636460118658103216465232904393614497292026369681635352019311970201,
      "iso_degree": 2**200,
      "quadratic_form": 2127448841056343541941029118293939656222437743*x1^2 + 862072184156666365618462032568060450526091666*x1*x2 + 1149429578875555154157949376757413934034788888*x1*x3 - 1166934923077423231012926852929447451002044287*x1*x4 + 3224592067252482317547911408316664487006783801*x2^2 + 2674350965562897604670593547460753895612008613*x2*x3 - 1436786973594443942697436720946767417543486110*x2*x4 + 3270006872778995071102689973024780783150181181*x3^2 + 287357394718888788539487344189353483508697222*x3*x4 + 4275935596284428135585570803097389284513972017*x4^2,
      "sol": [-15068121, -16403852, 10345209, -15303904],
      "known_variables": [0],
    },
    {
      "p" : 1440277892930363003468057636460118658103216465232904393614497292026369681635352019311970201,
      "iso_degree": 2**200,
      "quadratic_form": 947442558547499972840090421664780500336286440*x1^2 + 222006505247077872557498510378590966953279576*x1*x2 - 111003252623538936278749255189295483476639788*x1*x3 - 598611935794803365606328367133797078491262105*x1*x4 + 2076521737242843912895070711882323289019664958*x2^2 + 1364417874194459371231528920245815290480456467*x2*x3 + 333009757870616808836247765567886450429919364*x2*x4 + 4246455340240184179990987786478999409438502557*x3^2 + 1110032526235389362787492551892954834766397880*x3*x4 + 8910336328722272511846960593876907168369535861*x4^2,
      "sol": [15897369, -1415259, -12319644, 10153267],
      "known_variables": [3],
    },
    {
      "p" : 1440277892930363003468057636460118658103216465232904393614497292026369681635352019311970201,
      "iso_degree": 2**250,
      "quadratic_form": 1643332766101844214369642768247707011958882782*x1^2 + 613212358032362104529337538068517299682741852*x1*x2 - 833816100074240010621935384221344825186798156*x1*x3 - 641296424125833205755372092979332694344129735*x1*x4 + 2531634056987311977844282810634284876357134721*x2^2 + 1174375686802198456073921359081127561694614119*x2*x3 + 1383993965780451328512540392857465954617818330*x2*x4 + 3631344221856063323658586904120920512077487708*x3^2 + 1815672110928031661829293452060460256038743854*x3*x4 + 5447016332784094985487880356181380768116231562*x4^2,
      "sol": [613633309143435, 572710628618534, 118276914749744, -186344445742222],
      "known_variables": [0, 1],
    },
    {
      "p" : 2579908397044906386174096217920439652593588922415368592793419268598829754333482685849358216105220563528103302315835492749673140151624434689229190967453,
      "iso_degree": 2**330,
      "quadratic_form": 1476039848139568345957398233132065551070118393558818672086906013422308893138*x1^2 + 467183475178706746354846443735702396922025500428240632379497048864323244128*x1*x2 + 1476039848139568345957398233132065551070118393558818672086906013422308893138*x1*x3 + 1005668566614985649538186943083580981351153002547376000963797900179059174999*x1*x4 + 1788278465337625016639908319382448772211377472962964127041821744241368380148*x2^2 + 470371281524582696419211290048484569718965391011442671123108113243249718139*x2*x3 - 1554686727748271643462485097514597573750364722748843810852073219809206758084*x2*x4 + 4428119544418705037872194699396196653210355180676456016260718040266926679414*x3^2 + 1669199068081321715624027157724655396582170307052688562058836040060874460814*x3*x4 + 5498659717285475788199468871406120419542179321772875713585637679458057504659*x4^2,
      "sol": [-990745790576, 123088323358, -213144802835, -121167473484],
      "known_variables": [0],
    },
    {
      "p" : 2579908397044906386174096217920439652593588922415368592793419268598829754333482685849358216105220563528103302315835492749673140151624434689229190967453,
      "iso_degree": 2**350,
      "quadratic_form": 792814094238074816311294249299816506127060782526568837239990406585018399342*x1^2 + 729559611627376495080121883635622292234872769455952237838528517143500125208*x1*x2 - 126508965221396642462344731328388427784376026141233198802923778883036548268*x1*x3 - 92439550656919203670534041208748189688915496550713595433723813897548576841*x1*x4 + 1425220769706644503891765175620557379431451726884856135672588802994049841977*x2^2 + 1036438064055048321369829247892078670652357708930725114684136586363637548697*x2*x3 + 661762704531159522543164700334247882158285145401855557829592054557599308330*x2*x4 + 5885762180140416422908128784899725897103637900640851733557802839771296521590*x3^2 + 5506235284476226495521094590914560613750509822217152137149031503122186876786*x3*x4 + 10244641040307818310911135987374584567100620169531294879212323418356078240169*x4^2,
      "sol": [-71248566063074, -373594624032602, -134171483042985, 482723357768614],
      "known_variables": [0, 1],
    },
    {
      "p" : 2579908397044906386174096217920439652593588922415368592793419268598829754333482685849358216105220563528103302315835492749673140151624434689229190967453,
      "iso_degree": 2**390,
      "quadratic_form": 1361010983718916658037840523539496710738722176429112993100841721663420475498*x1^2 + 907340655812611105358560349026331140492481450952741995400561147775613650332*x1*x2 - 689569705975493478565984082846556011754042401285269143832701594526268503936*x1*x3 + 952103710884452183371588595901648032477092414747750548042764231230972947427*x1*x4 + 1814681311625222210717120698052662280984962901905483990801122295551227300664*x2^2 + 952103710884452183371588595901648032477092414747750548042764231230972947427*x2*x3 + 1554162081890292760335704507729840037323451478212192557138778280189006636866*x2*x4 + 4562363360614762576247532632811943963605707960059484351918916594796767096591*x3^2 + 3041575573743175050831688421874629309070471973372989567945944396531178064394*x3*x4 + 6083151147486350101663376843749258618140943946745979135891888793062356128788*x4^2,
      "sol": [-138398247611548888645, -1111598436980824259864, -7769179677861888979, -48648347616847355727],
      "known_variables": [0, 1],
   },
   {
      "p" : 2579908397044906386174096217920439652593588922415368592793419268598829754333482685849358216105220563528103302315835492749673140151624434689229190967453,
      "iso_degree": 2**395,
      "quadratic_form": 1130034136687505223431383342016877945848167765629507899157871130096471745721*x1^2 + 185240425265208501957508201476445768465066101222770410868862347690707399916*x1*x2 - 370480850530417003915016402952891536930132202445540821737724695381414799832*x1*x3 + 699403471957215712897589040602568081964459246458845367400721261922522954753*x1*x4 + 1322015403943574738654015971178662486872639538940334818574664074968820211022*x2^2 + 792739732393516673074647126784049645633989191556862753247849218781026675485*x2*x3 + 555721275795625505872524604429337305395198303668311232606587043072122199748*x2*x4 + 5556834423001225156979858623902908165571308883049522109942227693623855007873*x3^2 + 926202126326042509787541007382228842325330506113852054344311738453536999580*x3*x4 + 6470072629063422253004492726621090088858902777054648014102628439556345474012*x4^2,
      "sol": [-759040873721068948730, 1703294315244566194473, -3868190553487666421745, 252389899827062979905],
      "known_variables": [0, 1],
    },
  ]
 
  for ind, form in enumerate(forms):
    p = form["p"]
    S = spline([(58, 3), (6, 2), (101, 2), (121, 2), (141, 6), (151, 14), (161, 17), (166, 19), (171, 21), (181, 26), (201, 37), (211, 42), (251, 50), (331, 40), (351, 49), (391, 70), (396, 72)])
    iso_deg = form["iso_degree"].bit_length()
    b = 2**ceil(S(iso_deg))
    bounds = (b, b, b, b)

    Q.<i,j,k> = QuaternionAlgebra(QQ, -1, -p)
    I = Q.ideal([2, 1 - j, i + j, 3/2 + 1/2*i + 1/2*j + 1/2*k])

    iso_degree = form["iso_degree"]
    quadratic_form = form["quadratic_form"]
    sol = form["sol"]
    known_variables = form["known_variables"]
    f = quadratic_form - iso_degree 

    constant_polys = []
    for v in known_variables:
      if v == 0:
        f = f(x1 = sol[0])
        constant_polys.append(x1 - sol[0])
      elif v == 1:
        f = f(x2 = sol[1])
        constant_polys.append(x2 - sol[1])
      elif v == 2:
        f = f(x3 = sol[2])
        constant_polys.append(x3 - sol[2])
      elif v == 3:
        f = f(x4 = sol[3])
        constant_polys.append(x4 - sol[3])

    print("==========")
    print("f: ", f)
    print("known variables: ", known_variables)
    print("solution: ", sol)

    """
    if f.nvariables() == 2:
      x, y = transform_to_cornacchia_and_solve(f)
      var1 = f.variables()[0]
      var2 = f.variables()[1]
    """
      
    assert f(x1 = sol[0], x2 = sol[1], x3 = sol[2], x4 = sol[3]) == 0

    roots, _ = small_roots(f, constant_polys, bounds, p, sol, m=2, method=method, debug=True)
    print("roots: ", roots)

    assert len(roots) > 0

    for root in roots:
      print("---")
      print("root: ", root)
      g = None
      if 0 in known_variables:
        g = f(x1 = sol[0])
      if 1 in known_variables:
        g = f(x2 = sol[1])
      if 2 in known_variables:
        g = f(x3 = sol[2])
      if 3 in known_variables:
        g = f(x4 = sol[3])
      
      print(g)

      root_dict = {}
      for k, v in root.items():
        root_dict[str(k)] = v 
      
      keys = root_dict.keys()

      if "x1" in keys:
        g = g(x1 = root_dict["x1"])
      if "x2" in keys:
        g = g(x2 = root_dict["x2"])
      if "x3" in keys:
        g = g(x3 = root_dict["x3"])
      if "x4" in keys:
        g = g(x4 = root_dict["x4"])

      print("eval: ", g)
      assert g == 0

if __name__ == '__main__':
  if len(sys.argv) > 1:
    method = sys.argv[1]
    shortish_iso(method)
  else:
    shortish_iso()
